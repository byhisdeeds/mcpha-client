<!DOCTYPE html>
<!--
Copyright 2016 John Preston<byhisdeeds@gmail.com> NURAS.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>WSPHA</title>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="css/jspha.css" >
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../../excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="js/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="js/jquery-ui.js"></script>
    <script language="javascript" type="text/javascript" src="js/notify.js"></script>
    <script language="javascript" type="text/javascript" src="js/jquery.flot.js"></script>
    <script language="javascript" type="text/javascript" src="js/jquery.flot.crosshair.js"></script>
    <script language="javascript" type="text/javascript" src="js/jquery.flot.selection.js"></script>
    <script language="javascript" type="text/javascript" src="js/jquery.flot.resize.js"></script>
    <script type="text/javascript">

      $(function () {
        
        var yscale_ln_range = [100,500,2000,10000,50000,200000,1000000];
        
        var yscale_lg_range = [0.1,1,10,100,1000,10000];
        
        var hdata, hlabel, r1data, r1label, r2data, r2label, r3data, r3label;
        
        var roi2set = "";
        
        var plot, yscale;
        
        var ws;
        
        var options = {
          lines: {
            show: true,
            steps: true
          },
          points: {
            show: false
          },
          xaxis: {
            tickDecimals: 0,
            tickSize: 1,
            transform: function(x) {
              return x;
            }
          },
          yaxis: {
            max: 100,
            ticks: null,//[0.1,1,10,100,1000],
            transform:  null//function(v) {
            //  return Math.log(v+0.0001); /*move away from zero*/
            //},
            //tickDecimals: 3,
            //tickFormatter: function (v, axis) {
            //  return "10" + (Math.round( Math.log(v)/Math.LN10)).toString().sup();
            //}
          },
          grid: {
            backgroundColor: "#999",
            hoverable: true,
            clickable: true,
            autoHighlight: false
          },
          crosshair: {
            mode: "x"
          },
          zoom: {
            interactive: true
          },
          pan: {
            interactive: true
          },
          selection: {
            mode: "x"
          }
        };
        
        //
        // FIRST THINGS FIRST. IF PAGE IS NOT LOADED
        // VIA HTTP PROTOCOL THEN ITS A NO GO
        //
        if (window.location.protocol === "file:")
        {
          document.write("ERROR: This app must be loaded via a http web server.");
          return;
        }

        function setupWebsocket() {
          if ("WebSocket" in window) {

            updateConnectionStatus("ctws");

            ws = new WebSocket("ws://localhost:4567/wspha");

            ws.onopen = function () {
              updateConnectionStatus("wsce");
            };

            ws.onmessage = function (evt) {
              msg = JSON.parse(evt.data);
              if (msg.command === "connect") {
                logMessage(">>"+evt.data);
                if (msg.type !== "req") {
                  if (msg.status === 0) {
                    $.notify(msg.message, "success");
                    updateConnectionStatus("rpce");
                    $( "#deviceip" ).text("Disconnect from Device");
                    // get initial roi #1 value
                    if (localStorage.getItem('rp_roi1_start') !== null) {
                      ws.send("{\"type\":\"req\",\"command\":\"set_roi\",\"roi\":1,\"from\":"+localStorage.getItem('rp_roi1_start')+",\"to\":"+localStorage.getItem('rp_roi1_end')+"}");
                    }
                    // get initial roi #2 value
                    if (localStorage.getItem('rp_roi2_start') !== null) {
                      ws.send("{\"type\":\"req\",\"command\":\"set_roi\",\"roi\":2,\"from\":"+localStorage.getItem('rp_roi2_start')+",\"to\":"+localStorage.getItem('rp_roi2_end')+"}");
                    }
                    // fet initial roi #3 value
                    if (localStorage.getItem('rp_roi3_start') !== null) {
                      ws.send("{\"type\":\"req\",\"command\":\"set_roi\",\"roi\":3,\"from\":"+localStorage.getItem('rp_roi3_start')+",\"to\":"+localStorage.getItem('rp_roi3_end')+"}");
                    }
                  } else {
                    $.notify(msg.message, "error");
                    updateConnectionStatus("rpcd");
                    $( "#deviceip" ).text("Connect to Device");
                  }
                }
              } else if (msg.command === "disconnect") {
                logMessage(">>"+evt.data);
                updateConnectionStatus("rpcd");
                $( "#deviceip" ).text("Connect to Device");
              } else if (msg.command === "get_histogram_data") {
                if (msg.status === 0) {
                  $( "#elapsedtime" ).text(msg.timer);                
                  var axis = plot.getAxes();
                  options.xaxis.min = 0;
                  options.xaxis.max = 16300;
                  //options.yaxis.min = 0;
                  //options.yaxis.max = 4000;
                  options.xaxis.tickSize = 1000;
                  plotData(msg.label, msg.data, null, null, null, null, null, null, options);
                } else {
                  $.notify(msg.message, "error");                
                }
              } else if (msg.command === "get_roi_data") {
                if (msg.status === 0) {
                  if (typeof msg.roi1 !== "undefined") {
                    $("#roi1_counts").text(msg.roi1.counts);
                    $("#roi1_counts").prop("title", "From "+msg.roi1.start+" to "+msg.roi1.end);
                    plotData(null, null, msg.roi1.label, msg.roi1.data, null, null, null, null, options);
                  }
                  if (typeof msg.roi2 !== "undefined") {
                    $("#roi2_counts").text(msg.roi2.counts);
                    $("#roi2_counts").prop("title", "From "+msg.roi2.start+" to "+msg.roi2.end);
                    plotData(null, null, null, null, msg.roi2.label, msg.roi2.data, null, null, options);
                  }
                  if (typeof msg.roi3 !== "undefined") {
                    $("#roi3_counts").text(msg.roi3.counts);
                    $("#roi3_counts").prop("title", "From "+msg.roi3.start+" to "+msg.roi3.end);
                    plotData(null, null, null, null, null, null, msg.roi3.label, msg.roi3.data, options);
                  }
                } else {
                  $.notify(msg.message, "error");                
                }
              } else if (msg.command === "set_acquisition_time") {
                logMessage(">>"+evt.data);
                if (msg.type === "req") {
                  $( "#acqtime_s" ).text(msg.value);                
                } else {
                  if (msg.status === 0) {

                  } else {

                  }
                }
              } else if (msg.command === "set_acquisition_state" ||
                         msg.command === "get_acquisition_state") {
                logMessage(">>"+evt.data);
                if (msg.status === 0) {
                  if (msg.state === "active") {
                    $( "#start" ).text("Stop");
                    $( "#start" ).addClass("active");
                  } else {
                    $( "#start" ).text("Start");
                    $( "#start" ).removeClass("active");
                  }
                }
              } else if (msg.command === "set_roi") {
                logMessage(">>"+evt.data);
                roi2set = "";
                if (msg.type !== "req") {
                  if (msg.status === 0) {
                    if (msg.roi === 1) {
                      localStorage.setItem('rp_roi1_start', msg.start);
                      localStorage.setItem('rp_roi1_end', msg.end);
                      $( "#roi1_counts" ).text(msg.counts);
                      $( "#roi1_counts" ).prop("title", "From "+msg.start+" to "+msg.end);
                    } else if (msg.roi === 2) {
                      localStorage.setItem('rp_roi2_start', msg.start);
                      localStorage.setItem('rp_roi2_end', msg.end);
                      $( "#roi2_counts" ).text(msg.counts);
                      $( "#roi2_counts" ).prop("title", "From "+msg.start+" to "+msg.end);
                    } else if (msg.roi === 3) {
                      localStorage.setItem('rp_roi3_start', msg.start);
                      localStorage.setItem('rp_roi3_end', msg.end);
                      $( "#roi3_counts" ).text(msg.counts);
                      $( "#roi3_counts" ).prop("title", "From "+msg.start+" to "+msg.end);
                    }
                  }
                }
              }
            };

            ws.close = function() {
              // Web Socket has been closed
              logMessage(">>Websocket has been closed");
              updateConnectionStatus("wscd");
              // try and reconnect
              setTimeout(setupWebSocket, 2000);
            };

            ws.onerror = function (evt) {
              logMessage("**"+evt.data);
              alert("->"+evt.data);
            };
          } else {
            document.write("ERROR: This browser does NOT support websockets. Please use a HTML5 compliant browser.");
            return;
          }
        }
        
        function plotData(histogram_label, histogram_data, roi1_label, roi1_data, roi2_label, roi2_data, roi3_label, roi3_data, params) {
          var data = [];
          
          if (histogram_data !== null) {
            hdata = histogram_data;
            hlabel = histogram_label;
            data.push({label:histogram_label, data:histogram_data});
          } else {
            data.push({label:hlabel, data:hdata});
          }
          
          if (roi1_data !== null) {
            r1label = roi1_label;
            r1data = roi1_data;
            data.push({label:roi1_label, data:roi1_data, color:"#a22"});
          } else {
            data.push({label:r1label, data:r1data, color:"#a22"});
          }
          
          if (roi2_data !== null) {
            r2label = roi2_label;
            r2data = roi2_data;
            data.push({label:roi2_label, data:roi2_data, color:"#a22"});
          } else {
            data.push({label:r2label, data:r2data, color:"#a22"});
          }
          
          if (roi3_data !== null) {
            r3label = roi3_label;
            r3data = roi3_data;
            data.push({label:roi3_label, data:roi3_data, color:"#a22"});
          } else {
            data.push({label:r3label, data:r3data, color:"#a22"});
          }
          
          plot = $.plot("#spectrum-placeholder", data, params);
        }

        function set_vertical_scale(scale) {
          yscale = scale;
          $(".yscale-ln-button").removeClass("currentyscale");
          $(".yscale-lg-button").removeClass("currentyscale");
          $(".yscale-sq-button").removeClass("currentyscale");
          if (scale === "ln") {
            $(".yscale-ln-button").addClass("currentyscale");
            options.yaxis.ticks = null;
            options.yaxis.transform = null;
            options.yaxis.tickDecimals = null;
            options.yaxis.tickFormatter = null;
          } else if (scale === "lg") {
            $(".yscale-lg-button").addClass("currentyscale");
            options.yaxis.ticks = [0.1,1,10,100,1000];
            options.yaxis.transform = function(v) {
              return Math.log10(v+0.0001); /*move away from zero*/
            };
            options.yaxis.tickDecimals = 3;
            options.yaxis.tickFormatter = function (v, axis) {
              return "10" + (Math.round( Math.log10(v)/Math.LN10)).toString().sup();
            };
          } else if (scale === "sq") {
            $(".yscale-sq-button").addClass("currentyscale");
            options.yaxis.ticks = null;
            options.yaxis.transform = function(v) {
              return Math.sqrt(v+0.0001); /*move away from zero*/
            };
            options.yaxis.tickDecimals = null;
            options.yaxis.tickFormatter = null;
          }
        }
        
        function adjust_vertical_scale_and_plot(params, adjustment) {
          if (yscale === "ln") {
            if (adjustment > 0) {
              for (var i in yscale_ln_range) {
                alert(array[i]);
              }
              if (params.yaxis.max === 100) {
                params.yaxis.max = 100;
              } else if (params.yaxis.max < 500) {
                params.yaxis.max = 500;
              } else if (params.yaxis.max < 10000) {
                params.yaxis.max = 10000;
              } else if (params.yaxis.max < 50000) {
                params.yaxis.max = 50000;
              } else if (params.yaxis.max < 200000) {
                params.yaxis.max = 200000;
              } else if (params.yaxis.max < 1000000) {
                params.yaxis.max = 1000000;
              }
            } else if (adjustment < 0) {
              if (params.yaxis.max === 1000000) {
                params.yaxis.max = 200000;
              } else if (params.yaxis.max === 200000) {
                params.yaxis.max = 50000;
              } else if (params.yaxis.max === 50000) {
                params.yaxis.max = 10000;
              } else if (params.yaxis.max === 10000) {
                params.yaxis.max = 5000;
              } else if (params.yaxis.max === 5000) {
                params.yaxis.max = 1000;
              }
            }
          } else if (yscale === "lg") {
            
          } else if (yscale === "sq") {
            
          }
          replot(params);
        }

        function replot(params) {
          var data = [];
          
          data.push({label:hlabel, data:hdata});
          data.push({label:r1label, data:r1data, color:"#a22"});
          data.push({label:r2label, data:r2data, color:"#a22"});
          data.push({label:r3label, data:r3data, color:"#a22"});
          
          plot = $.plot("#spectrum-placeholder", data, params);
        }

        
        function logMessage(message) {
          $("<p>"+message+"</p>").appendTo('#message-log');
        }

        function initConnectionStatus() {
          $("#wsconnection").css("background-image","url(css/images/disconnected.png)");
          $("#wsconnection").prop("title", "Disconnected from web socket server");
        
          $("#rpconnection").css("background-image","url(css/images/disconnected.png)");
          $("#rpconnection").prop("title", "Disconnected from Red Pitaya device");
        }

        function updateConnectionStatus(mode) {
          if (mode === "ctws") {
            // connecting to web socket
            $("#wsconnection").css("background-image","url(css/images/spin.svg)");
            $("#wsconnection").prop("title", "Connecting to web socket");
            setAcquisitionButtonsEnabled( false );
          } else if (mode === "wsce"){
            // Web socket connection established
            $("#wsconnection").css("background-image","url(css/images/connected.png)");
            $("#wsconnection").prop("title", "Web socket server connection established");
            setAcquisitionButtonsEnabled( false );
          } else if (mode === "wscd"){
            // Web socket connection disconnected
            $("#wsconnection").css("background-image","url(css/images/disconnected.png)");
            $("#wsconnection").prop("title", "Web socket server connection disconnected");
            setAcquisitionButtonsEnabled( false );
          } else if (mode === "ctrp") {
            // connecting to red pitaya
            $("#rpconnection").css("background-image","url(css/images/spin.svg)");
            $("#rpconnection").prop("title", "Connecting to Red Pitaya device");
            setAcquisitionButtonsEnabled( false );
          } else if (mode === "rpce") {
            // red pitaya connection established
            $("#rpconnection").css("background-image","url(css/images/connected.png)");
            $("#rpconnection").prop("title", "Red Pitaya device connection established");
            setAcquisitionButtonsEnabled( true );
          } else if (mode === "rpcd") {
            // red pitaya connection disconnected
            $("#rpconnection").css("background-image","url(css/images/disconnected.png)");
            $("#rpconnection").prop("title", "Red Pitaya device connection disconnected");
            setAcquisitionButtonsEnabled( false );
          }
        }

        function setAcquisitionButtonsEnabled(state) {
          if (state) {
            $("#setacqtime").removeAttr("disabled");
            $("#setacqtime").css("color", "#000");
            $("#start").removeAttr("disabled");
            $("#start").css("color", "#000");
            $("#stop").removeAttr("disabled");
            $("#stop").css("color", "#000");
            $("#clear_time").removeAttr("disabled");
            $("#clear_time").css("color", "#000");
            $("#clear_s_data").removeAttr("disabled");
            $("#clear_s_data").css("color", "#000");
            $("#roi1").removeAttr("disabled");
            $("#roi1").css("color", "#000");
            $("#roi2").removeAttr("disabled");
            $("#roi2").css("color", "#000");
            $("#roi3").removeAttr("disabled");
            $("#roi3").css("color", "#000");
          } else {
            $("#setacqtime").attr("disabled", "disabled");
            $("#setacqtime").css("color", "#aaa");
            $("#start").attr("disabled", "disabled");
            $("#start").css("color", "#aaa");
            $("#stop").attr("disabled", "disabled");
            $("#stop").css("color", "#aaa");
            $("#clear_time").attr("disabled", "disabled");
            $("#clear_time").css("color", "#aaa");
            $("#clear_s_data").attr("disabled", "disabled");
            $("#clear_s_data").css("color", "#aaa");
            $("#roi1").attr("disabled", "disabled");
            $("#roi1").css("color", "#aaa");
            $("#roi2").attr("disabled", "disabled");
            $("#roi2").css("color", "#aaa");
            $("#roi3").attr("disabled", "disabled");
            $("#roi3").css("color", "#aaa");
          }
        }
    
        function yscaleFunction (y) {
          return y * .5;
        }

        function calculateFullExtent (variable) {
          var xmin =  10000000;
          var xmax = -10000000;
          var ymin =  10000000;
          var ymax = -10000000;
          
          $.each(variable, function(index, value) {
            $.each(value.data, function(index, value) {
              if (value[0] > xmax) {
                xmax = value[0];
              }
              if (value[0] < xmin) {
                xmin = value[0];
              }
              if (value[1] > ymax) {
                ymax = value[1];
              }
              if (value[1] < ymin) {
                ymin = value[1];
              }
            });
          });
          
          return {"xmin" : xmin, "xmax": xmax, "ymin": ymin, "ymax": ymax};
        }

        initConnectionStatus();

        setupWebsocket();

        // set a default device ip address
        if (localStorage.getItem('rp_ipaddr') === null) {
          localStorage.setItem('rp_ipaddr', "0.0.0.0");
          localStorage.setItem('rp_port', "0");
        }

        var allFields = $( [] ).add( ipaddr );
        var dialog_ipaddr = $( "#dialog-ipaddr" ).dialog({
          autoOpen: false,
          height: 400,
          width: 400,
          modal: true,
          buttons: {
            "Connect": function() {
              // Put the object into storage
              localStorage.setItem('rp_ipaddr', $( "#ipaddr" ).val());
              localStorage.setItem('rp_port', $( "#port" ).val());
              // connect to red pitaya device
              updateConnectionStatus("ctrp");
              ws.send("{\"type\":\"req\",\"command\":\"connect\",\"deviceip\":\""+$("#ipaddr").val()+"\",\"port\":"+$("#port").val()+"}");
              // close dialog
              dialog_ipaddr.dialog( "close" );
            },
            Cancel: function() {
              dialog_ipaddr.dialog( "close" );
            }
          },
          close: function() {
            form[ 0 ].reset();
            allFields.removeClass( "ui-state-error" );
          }
        });
        
        var form = dialog_ipaddr.find( "form" ).on( "submit", function( event ) {
          event.preventDefault();
        });
        
        var dialog_acqtime = $( "#dialog-acqtime" ).dialog({
          autoOpen: false,
          height: 400,
          width: 400,
          modal: true,
          buttons: {
            "OK": function() {
              // Put the object into storage
              localStorage.setItem('rp_acqtime', $( "#acqtime" ).val());
              // close dialog
              dialog_acqtime.dialog( "close" );
            },
            Cancel: function() {
              dialog_acqtime.dialog( "close" );
            }
          },
          close: function() {
            form[ 0 ].reset();
            allFields.removeClass( "ui-state-error" );
          }
        });
        
        var form = dialog_acqtime.find( "form" ).on( "submit", function( event ) {
          event.preventDefault();
        });

        $("button.deviceip").click(function () {
          if ($( "#deviceip" ).text().startsWith("Connect")) {
            // read the red pitaya device address from storage
            $( "#ipaddr" ).val(localStorage.getItem('rp_ipaddr'));
            $( "#port" ).val(localStorage.getItem('rp_port'));
            dialog_ipaddr.dialog( "open" );
          } else {
            ws.send("{\"type\":\"req\",\"command\":\"disconnect\"}");
          }
        });
        
        set_vertical_scale("ln");
        
        plot = $.plot("#spectrum-placeholder", [], options);

        var alreadyFetched = {};

        // Set Y display to linear
        $("button.yscale-ln-button").click(function () {
          set_vertical_scale("ln");
          replot(options);
        });

        // Set Y display to square root
        $("button.yscale-sq-button").click(function () {
          set_vertical_scale("sq");
          replot(options);
        });

        // Set Y display to log10
        $("button.yscale-lg-button").click(function () {
          set_vertical_scale("lg");
          replot(options);
        });

        // zoom to full channel extent button click handler
        $("button.zoom-full-extent-button").click(function () {
          var axis = plot.getAxes();
          options.xaxis.min = axis.xaxis.datamin;
          options.xaxis.max = Math.ceil(axis.xaxis.datamax);
          options.yaxis.min = 0;
          options.yaxis.max = Math.ceil(axis.yaxis.datamax);
          replot(options);
        });

        $("button.zoom-in-button").click(function () {
          var axis = plot.getAxes();
          var xrng = (options.xaxis.max - options.xaxis.min) / 4;
          if (xrng < 2) {
            return;
          }
          options.xaxis.min += xrng;
          if (options.xaxis.min < axis.xaxis.datamin) {
            options.xaxis.min = axis.xaxis.datamin;
          }
          options.xaxis.max -= xrng;
          if (options.xaxis.max > axis.xaxis.datamax) {
            options.xaxis.max = axis.xaxis.datamax;
          }
          replot(options);
        });

        $("button.zoom-out-button").click(function () {
          var axis = plot.getAxes();
          var xrng = (options.xaxis.datamax - options.xaxis.datamin) / 4;
          if (xrng < 2) {
            return;
          }
          options.xaxis.min -= xrng;
          if (options.xaxis.min < axis.xaxis.datamin) {
            options.xaxis.min = axis.xaxis.datamin;
          }
          options.xaxis.max += xrng;
          if (options.xaxis.max > axis.xaxis.datamax) {
            options.xaxis.max = axis.xaxis.datamax;
          }
          replot(options);
        });

        $("button.pan-button").click(function () {
//          plot.pan({ left: -2 });
          options.xaxis.min = 5400;
          options.xaxis.max = 5500;
          replot(options);
        });

        //
        // Set initial acquisition time
        //
        if (localStorage.getItem("rp_acqtime") === null) {
          // use default value of 60 seconds
          localStorage.setItem('rp_acqtime', "60");
        }
        $( "#acqtime_s" ).text(localStorage.getItem("rp_acqtime"));
        
        //
        // Set acquisition time button click handler
        //
        $("#setacqtime").click(function () {
          $( "#acqtime" ).val(localStorage.getItem('rp_acqtime'));
          dialog_acqtime.dialog( "open" );
        });
        
        // set initial elapsedtime
        $( "#elapsedtime" ).text("0");

        //
        // START/STOP button click handler
        //
        $("#start").click(function () {
          if ( $("#start" ).text() === "Start") {
            ws.send("{\"type\":\"req\",\"command\":\"set_acquisition_state\",\"state\":1,\"acqtime\":"+localStorage.getItem("rp_acqtime")+"}");
          } else {
            ws.send("{\"type\":\"req\",\"command\":\"set_acquisition_state\",\"state\":0}");
          }
        });

        //
        // CLEAR spectrum data button click handler
        //
        $("#clear_s_data").click(function () {
          ws.send("{\"type\":\"req\",\"command\":\"clear_spectrum_data\"}");
        });

        //
        // CLEAR aquisition timer button click handler
        //
        $("#clear_time").click(function () {
          alert("CLEAR AQUISITION TIMER");
        });

        //
        // Set initial ROI total counts values
        //
        $( "#roi1_counts" ).text(0);
        $( "#roi2_counts" ).text(0);
        $( "#roi3_counts" ).text(0);

        //
        // Install set ROI #1 click handler
        //
        $("#roi1").click(function () {
          roi2set = "1";
          $("#roi1").addClass("currentroi");
          $.notify("Select ROI #1 region using mouse", "info");
        });

        //
        // Install set ROI #2 click handler
        //
        $("#roi2").click(function () {
          roi2set = "2";
          $("#roi2").addClass("currentroi");
          $.notify("Select ROI #2 region using mouse", "info");
        });

        //
        // Install set ROI #3 click handler
        //
        $("#roi3").click(function () {
          roi2set = "3";
          $("#roi3").addClass("currentroi");
          $.notify("Select ROI #3 region using mouse", "info");
        });

        $("#spectrum-placeholder").bind("plotselected", function (event, ranges) {
          if (roi2set !== "") {
            ws.send("{\"type\":\"req\",\"command\":\"set_roi\",\"roi\":"+
                    roi2set+",\"from\":"+ranges.xaxis.from.toFixed(0)+",\"to\":"+
                    ranges.xaxis.to.toFixed(0)+"}");
            $("#roi"+roi2set).removeClass("currentroi");
            plot.clearSelection();
          }
        });

        $("#spectrum-placeholder").bind("plothover", function (event, pos, item) {
          if (plot.getData().length > 0) {
            $("#spectrum-placeholder").css("cursor","pointer","important");
            //$("#cursor").text(item.datapoint[0].toFixed(0));
            var x = pos.x.toFixed(0);
            var y = plot.getData()[0].data[x][1];
            $("#cursor").text(x);
            $("#counts").text(y);
            //$("#counts").text(item.datapoint[1].toFixed(2));
          } else {
            $("#spectrum-placeholder").css("cursor","crosshair", "important");
          }
        });
        $("#cursor").text("0");

        // Catch keypressess
        // left = 37, up = 38, right = 39, down = 40
        $(document).keyup(function (e) {
          if (e.which === 37) {
            alert('You pressed left!');
          } else if (e.which === 38) {
            adjust_vertical_scale_and_plot(options, +1);
          } else if (e.which === 39) {
            alert('You pressed right!');
          } else if (e.which === 40) {
            adjust_vertical_scale_and_plot(options, -1);
          } else if (e.which === 13) {
            alert('You pressed enter!');
          }
        });
        
        setAcquisitionButtonsEnabled(false);
        
        $( "#tabs" ).tabs();
        $( "#tabs ul li").css({'margin-right':'25px'});
//        $(".spectrum-container").resizable({
//          maxWidth: 900,
//          maxHeight: 500,
//          minWidth: 450,
//          minHeight: 250
//        });
      });

    </script>
  </head>
  <body>

    <div id="content">
      
      <div class="connection-panel-container">
        <div class="connection-panel-content">
          <div class="wsconnection" id="wsconnection" title="Websocket connection status"></div>
          <div class="rpconnection" id="rpconnection" title="Red Pitaya device connection status"></div>
          <button class="deviceip" id="deviceip" title="Set Red Pitaya device IP">Connect to Device</button>
        </div>
        <div class="logo">
          MCPHA Client
        </div>
      </div>

      <div id="tabs">
        <div id="fragment-mca">

          <div class="cursor-panel-container">
            <div class="cursor-panel-content">Cursor ......... : <span class="onscreen-message" id="cursor"></span>
Counts ......... : <span class="onscreen-message" id="counts"></span>
Acq. Time (s) .. : <span class="onscreen-message" id="acqtime_s"></span>
Elapsed Time (s) : <span class="onscreen-message" id="elapsedtime"></span>
ROI #1 ......... : <span class="onscreen-message" id="roi1_counts"></span>
ROI #2 ......... : <span class="onscreen-message" id="roi2_counts"></span>
ROI #3 ......... : <span class="onscreen-message" id="roi3_counts"></span></div>
          </div>

          <div class="spectrum-container">
            <div id="header">
              <button class="zoom-full-extent-button" title="Zoom channel view to full extent"></button>
              <button class="zoom-in-button" title="Zoom channel view in"></button>
              <button class="zoom-out-button" title="Zoom out channel view"></button>
              <button class="pan-button" title="Pan channel view"></button>
              <div style="width:8px;display:inline-block"></div>
              <button class="yscale-ln-button" title="Linear vertical scale">LN</button>
              <button class="yscale-sq-button" title="Square Root vertical scale">SQ</button>
              <button class="yscale-lg-button" title="Log 10 vertical scale">LG</button>
            </div>
            <div class="controls-panel-container">
              <div class="controls-panel-content">
                <button class="button setacqtime" id="setacqtime" title="Set acquisition time">Acq. Time</button>
                <button class="button start" id="start" title="Start spectrum acquisition">Start</button>
                <button class="button clear_s_data" id="clear_s_data" title="Clear spectrum data">Clear Spc.</button>
                <button class="button clear_time" id="clear_time" title="Clear aquisition time data">Clear Time</button>
                <div style="width:8px;display:inline-block"></div>
                <button class="button roi1" id="roi1" title="Set ROI #1">ROI #1</button>
                <button class="button roi2" id="roi2" title="Set ROI #2">ROI #2</button>
                <button class="button roi3" id="roi3" title="Set ROI #3">ROI #3</button>
              </div>
            </div>
            <div id="spectrum-placeholder" class="spectrum-placeholder"></div>
          </div>
        </div>

        <div id="dialog-ipaddr" title="Red Pitaya Device IP Address/Port">
          <p class="dialogPrompt">Enter device IP address and port.</p>

          <form>
            <fieldset>
              <label for="ipaddr">IP Address</label>
              <input type="text" name="ipaddr" id="ipaddr" value="0.0.0.0" class="text ui-widget-content ui-corner-all">

              <label for="port">Port</label>
              <input type="text" name="port" id="port" value="0" class="text ui-widget-content ui-corner-all">

              <!-- Allow form submission with keyboard without duplicating the dialog button -->
              <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
          </form>
        </div>

        <div id="dialog-acqtime" title="Aquisition Time">
          <p class="dialogPrompt">Enter acquisition time in seconds.</p>

          <form>
            <fieldset>
              <label for="acqtime">Acquisition Time (s)</label>
              <input type="text" name="acqtime" id="acqtime" value="60" class="text ui-widget-content ui-corner-all">

              <!-- Allow form submission with keyboard without duplicating the dialog button -->
              <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
          </form>
        </div>
        <div id="fragment-oscilloscope">
          <div id="content">
            Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat.
            Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat.
          </div>
        </div>
        <div id="fragment-log">
          <div id="content">
            <div id="message-log"></div>
          </div>
        </div>
        <ul>
          <li><a href="#fragment-mca"><span>MCA</span></a></li>
          <li><a href="#fragment-oscilloscope"><span>Oscilloscope</span></a></li>
          <li><a href="#fragment-log"><span>Message Log</span></a></li>
        </ul>
      </div>
    </div>
  
  </body>
</html>