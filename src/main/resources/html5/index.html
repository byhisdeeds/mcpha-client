<!DOCTYPE html>
<!--
Copyright 2016 John Preston<byhisdeeds@gmail.com> NURAS.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>WSPHA</title>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="css/jspha.css" >
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../../excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="js/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="js/jquery-ui.js"></script>
    <script language="javascript" type="text/javascript" src="js/notify.js"></script>
    <script language="javascript" type="text/javascript" src="js/jquery.flot.js"></script>
    <!-- <script language="javascript" type="text/javascript" src="js/jquery.flot.crosshair.js"></script> -->
    <script language="javascript" type="text/javascript" src="js/jquery.flot.selection.js"></script>
    <script language="javascript" type="text/javascript" src="js/jquery.flot.resize.js"></script>
    <script type="text/javascript">
      // Returns a function, that, as long as it continues to be invoked, will not
      // be triggered. The function will be called after it stops being called for
      // N milliseconds. If `immediate` is passed, trigger the function on the
      // leading edge, instead of the trailing.
      function debounce(func, wait, immediate) {
        var timeout;
        return function() {
          var context = this, args = arguments;
          var later = function() {
            timeout = null;
            if (!immediate) func.apply(context, args);
          };
          var callNow = immediate && !timeout;
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
          if (callNow) func.apply(context, args);
        };
      };
      
      //
      //  <a download="My-FileName.txt" href="data:application/octet-stream,HELLO-WORLDDDDDDDD">Click here</a> 
      //
      $(function () {
        
        // oscilloscope data plot variables
        var odata0, odata1, olabel0, olabel1;
        var oplot;
        
        
        
        // pulse height data plot variables
        var acquiring = false;
        
        var yscale_ln_range = [100,500,2000,10000,50000,200000,1000000];
        
        var yscale_lg_range = [0.1,1,10,100,1000,10000];
        
        var zoom_mode = "";
        
        var hdata, hlabel, r1data, r1label, r2data, r2label, r3data, r3label;
        
        var roi2set = "";
        
        var plot, yscale;
        
        var ws;
        
        var options = {
          lines: {
            show: true,
            steps: true
          },
          points: {
            show: false
          },
          xaxis: {
            tickDecimals: 0,
            tickSize: 1000,
            min: 0,
            max: 16384,
            transform: function(x) {
              return x;
            }
          },
          yaxis: {
            labelWidth: 140,
            reserveSpace: true,
            position: "right",
            max: 100,
            min: 0,
            ticks: null,//[0.1,1,10,100,1000],
            transform:  null//function(v) {
            //  return Math.log(v+0.0001); /*move away from zero*/
            //},
            //tickDecimals: 3,
            //tickFormatter: function (v, axis) {
            //  return "10" + (Math.round( Math.log(v)/Math.LN10)).toString().sup();
            //}
          },
          grid: {
            backgroundColor: "#999",
            hoverable: true,
            clickable: true,
            autoHighlight: false
          },
          crosshair: {
            mode: "x"
          },
          zoom: {
            interactive: true
          },
          pan: {
            interactive: true
          },
          selection: {
            mode: "x"
          }
        };
        
        //
        // FIRST THINGS FIRST. IF PAGE IS NOT LOADED
        // VIA HTTP PROTOCOL THEN ITS A NO GO
        //
        if (window.location.protocol === "file:")
        {
          document.write("ERROR: This app must be loaded via a http web server.");
          return;
        }

        function setupWebsocket() {
          if ("WebSocket" in window) {

            updateConnectionStatus("ctws");

            ws = new WebSocket("ws://localhost:4567/mcpha");

            ws.onopen = function () {
              updateConnectionStatus("wsce");
            };

            ws.onmessage = function (evt) {
              msg = JSON.parse(evt.data);
              if (msg.command === "connect") {
                logMessage(">>"+evt.data);
                if (msg.type !== "req") {
                  if (msg.status === 0) {
                    $.notify(msg.message, "success");
                    updateConnectionStatus("rpce");
                    $( "#deviceip" ).text("Disconnect from Device");
                    // if ROI's are defined them update server
                    update_server_roi_info();
                  } else {
                    $.notify(msg.message, "error");
                    updateConnectionStatus("rpcd");
                    $( "#deviceip" ).text("Connect to Device");
                  }
                }
              } else if (msg.command === "disconnect") {
                logMessage(">>"+evt.data);
                updateConnectionStatus("rpcd");
                $( "#deviceip" ).text("Connect to Device");
              } else if (msg.command === "get_histogram_data") {
                if (msg.status === 0) {
                  $( "#elapsedtime" ).text(msg.timer);                
                  plotData(msg.label, msg.data, null, null, null, null, null, null, options);
                } else {
                  $.notify(msg.message, "error");                
                }
              } else if (msg.command === "set_acquisition_time") {
                logMessage(">>"+evt.data);
                if (msg.type === "req") {
                  $( "#acqtime_s" ).text(msg.value);                
                } else {
                  if (msg.status === 0) {

                  } else {

                  }
                }
              } else if (msg.command === "set_acquisition_state" ||
                         msg.command === "get_acquisition_state") {
                logMessage(">>"+evt.data);
                if (msg.status === 0) {
                  acquiring = (msg.state === "active");
                  if (acquiring) {
                    $( "#start" ).text("Stop");
                    $( "#start" ).addClass("active");
                    $.notify("Acquisition started", "info");                
                  } else {
                    $( "#start" ).text("Start");
                    $( "#start" ).removeClass("active");
                    $.notify("Acquisition stopped", "info");                
                  }
                }
              } else if (msg.command === "get_roi_data") {
                if (msg.status === 0) {
                  var roi = msg.roi;
                  $("#roi"+roi+"_counts").text(msg.counts);
                  $("#roi"+roi+"_counts").prop("title", "From "+msg.start+" to "+msg.end);
                  if (roi === 1) {
                    plotData(null, null, msg.label, msg.data, null, null, null, null, options);
                  } else if (roi === 2) {
                    plotData(null, null, null, null, msg.label, msg.data, null, null, options);
                  } else if (roi === 3) {
                    plotData(null, null, null, null, null, null, msg.label, msg.data, options);
                  }
                } else {
                  $.notify(msg.message, "error");                
                }
              } else if (msg.command === "set_roi") {
                logMessage(">>"+evt.data);
                roi2set = "";
                if (msg.type === "req") {
                  if (msg.roi === 1) {
                    localStorage.setItem('mcpha_roi1_start', msg.from);
                    localStorage.setItem('mcpha_roi1_end', msg.to);
                    $( "#roi1_counts" ).text("0");
                    $( "#roi1_counts" ).prop("title", "From "+msg.from+" to "+msg.to);
                  } else if (msg.roi === 2) {
                    localStorage.setItem('mcpha_roi2_start', msg.from);
                    localStorage.setItem('mcpha_roi2_end', msg.to);
                    $( "#roi2_counts" ).text("0");
                    $( "#roi2_counts" ).prop("title", "From "+msg.from+" to "+msg.to);
                  } else if (msg.roi === 3) {
                    localStorage.setItem('mcpha_roi3_start', msg.from);
                    localStorage.setItem('mcpha_roi3_end', msg.to);
                    $( "#roi3_counts" ).text("0");
                    $( "#roi3_counts" ).prop("title", "From "+msg.from+" to "+msg.to);
                  }
                }
              } else if (msg.command === "get_oscilloscope_data") {
                if (msg.status === 0) {
                  plot_oscilloscope_data(msg.label1, msg.data1, msg.label2, msg.data2, {});
                } else {
                  $.notify(msg.message, "error");
                }
              }
            };

            ws.close = function() {
              // Web Socket has been closed
              logMessage(">>Websocket has been closed");
              updateConnectionStatus("wscd");
              // try and reconnect
              setTimeout(setupWebSocket, 2000);
            };

            ws.onerror = function (evt) {
              logMessage("**"+evt.data);
              alert("->"+evt.data);
            };
          } else {
            document.write("ERROR: This browser does NOT support websockets. Please use a HTML5 compliant browser.");
            return;
          }
        }

        function update_server_roi_info() {
          for (i = 1; i < 4; i++) {
            var roi = localStorage.getItem('mcpha_roi'+i+'_start');
            if (roi !== null && roi !== 'undefined') {
              ws.send("{\"type\":\"req\",\"command\":\"set_roi\",\"roi\":"+i+
                      ",\"from\":"+localStorage.getItem('mcpha_roi'+i+'_start')+
                      ",\"to\":"+localStorage.getItem('mcpha_roi'+i+'_end')+"}");
            }
          }
        }
        
        function plotData(histogram_label, histogram_data, roi1_label, roi1_data, roi2_label, roi2_data, roi3_label, roi3_data, params) {
          var data = [];
          
          if (histogram_data !== null) {
            hdata = histogram_data;
            hlabel = histogram_label;
            data.push({label:histogram_label, data:histogram_data});
          } else {
            data.push({label:hlabel, data:hdata});
          }
          
          if (roi1_data !== null) {
            r1label = roi1_label;
            r1data = roi1_data;
            data.push({label:roi1_label, data:roi1_data, color:"#a22"});
          } else {
            data.push({label:r1label, data:r1data, color:"#a22"});
          }
          
          if (roi2_data !== null) {
            r2label = roi2_label;
            r2data = roi2_data;
            data.push({label:roi2_label, data:roi2_data, color:"#a22"});
          } else {
            data.push({label:r2label, data:r2data, color:"#a22"});
          }
          
          if (roi3_data !== null) {
            r3label = roi3_label;
            r3data = roi3_data;
            data.push({label:roi3_label, data:roi3_data, color:"#a22"});
          } else {
            data.push({label:r3label, data:r3data, color:"#a22"});
          }
          
          plot = $.plot("#spectrum-placeholder", data, params);
        }

        function set_vertical_scale(scale) {
          yscale = scale;
          $(".yscale-ln-button").removeClass("current-yscale");
          $(".yscale-lg-button").removeClass("current-yscale");
          $(".yscale-sq-button").removeClass("current-yscale");
          if (scale === "ln") {
            $(".yscale-ln-button").addClass("current-yscale");
            options.yaxis.ticks = null;
            options.yaxis.transform = null;
            options.yaxis.tickDecimals = null;
            options.yaxis.tickFormatter = null;
          } else if (scale === "lg") {
            $(".yscale-lg-button").addClass("current-yscale");
            options.yaxis.ticks = [0.1,1,10,100,1000];
            options.yaxis.transform = function(v) {
              return Math.log10(v+0.0001); /*move away from zero*/
            };
            options.yaxis.tickDecimals = 3;
            options.yaxis.tickFormatter = function (v, axis) {
              return "10" + (Math.round( Math.log10(v)/Math.LN10)).toString().sup();
            };
          } else if (scale === "sq") {
            $(".yscale-sq-button").addClass("current-yscale");
            options.yaxis.ticks = null;
            options.yaxis.transform = function(v) {
              return Math.sqrt(v+0.0001); /*move away from zero*/
            };
            options.yaxis.tickDecimals = null;
            options.yaxis.tickFormatter = null;
          }
        }
        
        function adjust_vertical_scale_and_plot(params, adjustment) {
          if (yscale === "ln") {
            if (adjustment > 0) {
              for ( var i = 0, l = yscale_ln_range.length - 1; i < l; i++ ) {
                if (params.yaxis.max <= yscale_ln_range[i]) {
                  params.yaxis.max = yscale_ln_range[i+1];
                  break;
                }
              }
            } else if (adjustment < 0) {
              for ( var i = yscale_ln_range.length-1; i > 0; i-- ) {
                if (params.yaxis.max >= yscale_ln_range[i]) {
                  params.yaxis.max = yscale_ln_range[i-1];
                  break;
                }
              }
            }
          } else if (yscale === "lg") {
            
          } else if (yscale === "sq") {
            
          }
          replot(params);
        }

        function get_zoom_ticks(xmin, xmax) {
          var xrng = xmax - xmin;
          if (xrng < 100) {
            t = 10;
          } else if (xrng < 500) {
            t = 50;
          } else if (xrng < 1000) {
            t = 100;
          } else if (xrng < 2000) {
            t = 200;
          } else if (xrng < 5000) {
            t = 500;
          } else if (xrng < 10000) {
            t = 1000;
          } else {
            t = 1000;
          }
          return t;
        }
        
        function set_selection_mode(mode, param) {
          if (mode === "clearall") {
            // first clear any roiset modes
            if (roi2set !== "") {
              $("#roi"+roi2set).removeClass("current-roi");
              roi2set = "";
            }
            // now clear any zoomin mode
            if (zoom_mode !== "") {
              $("button.zoom-in-button").removeClass("current-zoom");
              zoom_mode = "";
            }
          } else if (mode === "zoomin") {
            // first clear any roiset modes
            if (roi2set !== "") {
              $("#roi"+roi2set).removeClass("current-roi");
              roi2set = "";
            }
            // now set zoomin mode
            if (zoom_mode === "") {
              $("button.zoom-in-button").addClass("current-zoom");
              zoom_mode = mode;
            }
            $.notify("Select spectrum region using mouse.", "info");
          } else if (mode === "roi2set") {
            if (acquiring) {
              $.notify("Cannot set ROI while acquiring spectra.", "info");              
            } else {
              // first clear any zoomin mode
              if (zoom_mode !== "") {
                $("button.zoom-in-button").removeClass("current-zoom");
                zoom_mode = "";
              }
              // now set roiset mode
              if (roi2set !== "") {
                $("#roi"+roi2set).removeClass("current-roi");
                roi2set = "";
              }
              roi2set = param;
              $("#roi"+param).addClass("current-roi");
              $.notify("Select ROI #" + param + " region using mouse.", "info");
            }
          }
        }

        function zoom_around_cursor_xpos(xpos) {
          if (plot.getData().length > 0) {
            // zoom in by a factor of 2
            var axes = plot.getAxes();
            var dmin = parseInt(axes.xaxis.datamin);
            var dmax = parseInt(axes.xaxis.datamax);
            var xmin = parseInt(options.xaxis.min);
            var xmax = parseInt(options.xaxis.max);
            var xrng = (xmax - xmin) / 2;
            if (xrng > 100) {
              xrng /= 2;
              xmin += (parseInt(xpos) - xmin) / 2;
              xmax -= (xmax - parseInt(xpos)) / 2;
              if (xmin < dmin) {
                xmin = dmin;
                xmax = xmin + (xrng * 2);
              } else if (xmax > dmax) {
                xmax = dmax;
                xmin = xmax - (xrng * 2);
              }
              options.xaxis.min = xmin;
              options.xaxis.max = xmax;
              options.xaxis.tickSize = get_zoom_ticks(xmin, xmax);
              if (!acquiring) {
                replot(options);
              }
            }
          }
        }
        
        function replot(params) {
          var data = [];
          
          data.push({label:hlabel, data:hdata});
          data.push({label:r1label, data:r1data, color:"#a22"});
          data.push({label:r2label, data:r2data, color:"#a22"});
          data.push({label:r3label, data:r3data, color:"#a22"});
          
          plot = $.plot("#spectrum-placeholder", data, params);
        }

        function resize_flot_div(w, h) {
          // resize spectrum plot
          $(".fragment-side-panel").height((h-140)+"px");
          $(".fragment-body").height((h-140)+"px");
          $(".spectrum-container").height((h-150)+"px");
          $(".spectrum-placeholder").height((h-230)+"px");
          // resize message-log
          $("#message-log").height((h-123)+"px");
          // resize oscilloscope plot
          //$(".oscilloscope-container").height((h-160)+"px");
          //$(".oscilloscope-placeholder").height((h-230)+"px");
        }
        
        function logMessage(message) {
          $("<p>"+message+"</p>").appendTo('#message-log');
        }

        function initConnectionStatus() {
          $("#wsconnection").css("background-image","url(css/images/disconnected.png)");
          $("#wsconnection").prop("title", "Disconnected from web socket server");
        
          $("#rpconnection").css("background-image","url(css/images/disconnected.png)");
          $("#rpconnection").prop("title", "Disconnected from Red Pitaya device");
        }

        function updateConnectionStatus(mode) {
          if (mode === "ctws") {
            // connecting to web socket
            $("#busy").show();
            $("#wsconnection").prop("title", "Connecting to web socket");
            setAcquisitionButtonsEnabled( false );
          } else if (mode === "wsce"){
            // Web socket connection established
            $("#busy").hide();
            $("#wsconnection").css("background-image","url(css/images/connected.png)");
            $("#wsconnection").prop("title", "Web socket server connection established");
            $.notify("Websocket connection established", "info");
            setAcquisitionButtonsEnabled( false );
          } else if (mode === "wscd"){
            // Web socket connection disconnected
            $("#busy").hide();
            $("#wsconnection").css("background-image","url(css/images/disconnected.png)");
            $("#wsconnection").prop("title", "Web socket server connection disconnected");
            setAcquisitionButtonsEnabled( false );
          } else if (mode === "ctrp") {
            // connecting to red pitaya
            $("#busy").show();
            $("#rpconnection").prop("title", "Connecting to Red Pitaya device");
            setAcquisitionButtonsEnabled( false );
          } else if (mode === "rpce") {
            // red pitaya connection established
            $("#busy").hide();
            $("#rpconnection").css("background-image","url(css/images/connected.png)");
            $("#rpconnection").prop("title", "Red Pitaya device connection established");
            setAcquisitionButtonsEnabled( true );
          } else if (mode === "rpcd") {
            // red pitaya connection disconnected
            $("#busy").hide();
            $("#rpconnection").css("background-image","url(css/images/disconnected.png)");
            $("#rpconnection").prop("title", "Red Pitaya device connection disconnected");
            setAcquisitionButtonsEnabled( false );
          }
        }

        function setAcquisitionButtonsEnabled(state) {
          if (state) {
            $("#setacqtime").removeAttr("disabled");
            $("#setacqtime").css("color", "#000");
            $("#start").removeAttr("disabled");
            $("#start").css("color", "#000");
            $("#stop").removeAttr("disabled");
            $("#stop").css("color", "#000");
            $("#clear_time").removeAttr("disabled");
            $("#clear_time").css("color", "#000");
            $("#clear_s_data").removeAttr("disabled");
            $("#clear_s_data").css("color", "#000");
            $("#roi1").removeAttr("disabled");
            $("#roi1").css("color", "#000");
            $("#roi2").removeAttr("disabled");
            $("#roi2").css("color", "#000");
            $("#roi3").removeAttr("disabled");
            $("#roi3").css("color", "#000");
          } else {
            $("#setacqtime").attr("disabled", "disabled");
            $("#setacqtime").css("color", "#aaa");
            $("#start").attr("disabled", "disabled");
            $("#start").css("color", "#aaa");
            $("#stop").attr("disabled", "disabled");
            $("#stop").css("color", "#aaa");
            $("#clear_time").attr("disabled", "disabled");
            $("#clear_time").css("color", "#aaa");
            $("#clear_s_data").attr("disabled", "disabled");
            $("#clear_s_data").css("color", "#aaa");
            $("#roi1").attr("disabled", "disabled");
            $("#roi1").css("color", "#aaa");
            $("#roi2").attr("disabled", "disabled");
            $("#roi2").css("color", "#aaa");
            $("#roi3").attr("disabled", "disabled");
            $("#roi3").css("color", "#aaa");
          }
        }
    
        function yscaleFunction (y) {
          return y * .5;
        }

        function calculateFullExtent (variable) {
          var xmin =  10000000;
          var xmax = -10000000;
          var ymin =  10000000;
          var ymax = -10000000;
          
          $.each(variable, function(index, value) {
            $.each(value.data, function(index, value) {
              if (value[0] > xmax) {
                xmax = value[0];
              }
              if (value[0] < xmin) {
                xmin = value[0];
              }
              if (value[1] > ymax) {
                ymax = value[1];
              }
              if (value[1] < ymin) {
                ymin = value[1];
              }
            });
          });
          
          return {"xmin" : xmin, "xmax": xmax, "ymin": ymin, "ymax": ymax};
        }

        initConnectionStatus();

        setupWebsocket();

        // set a default device ip address
        if (localStorage.getItem('mcpha_ipaddr') === null) {
          localStorage.setItem('mcpha_ipaddr', "0.0.0.0");
          localStorage.setItem('mcpha_port', "0");
        }

        var allFields = $( [] ).add( ipaddr );
        var dialog_ipaddr = $( "#dialog-ipaddr" ).dialog({
          autoOpen: false,
          height: 400,
          width: 400,
          modal: true,
          buttons: {
            "Connect": function() {
              // Put the object into storage
              localStorage.setItem('mcpha_ipaddr', $( "#ipaddr" ).val());
              localStorage.setItem('mcpha_port', $( "#port" ).val());
              // connect to red pitaya device
              updateConnectionStatus("ctrp");
              ws.send("{\"type\":\"req\",\"command\":\"connect\",\"deviceip\":\""+
                      $("#ipaddr").val()+"\",\"port\":"+$("#port").val()+"}");
              // close dialog
              dialog_ipaddr.dialog( "close" );
            },
            Cancel: function() {
              dialog_ipaddr.dialog( "close" );
            }
          },
          close: function() {
            form[ 0 ].reset();
            allFields.removeClass( "ui-state-error" );
          }
        });
        
        var form = dialog_ipaddr.find( "form" ).on( "submit", function( event ) {
          event.preventDefault();
        });
        
        var dialog_acqtime = $( "#dialog-acqtime" ).dialog({
          autoOpen: false,
          height: 400,
          width: 400,
          modal: true,
          buttons: {
            "OK": function() {
              // Put the object into storage
              localStorage.setItem('mcpha_acqtime', $( "#acqtime" ).val());
              // close dialog
              dialog_acqtime.dialog( "close" );
            },
            Cancel: function() {
              dialog_acqtime.dialog( "close" );
            }
          },
          close: function() {
            form[ 0 ].reset();
            allFields.removeClass( "ui-state-error" );
          }
        });
        
        var form = dialog_acqtime.find( "form" ).on( "submit", function( event ) {
          event.preventDefault();
        });

        var resize_handler = debounce(function() {
          resize_flot_div($(window).width(), $(window).height());
        }, 400);

        $("button.deviceip").click(function () {
          if ($( "#deviceip" ).text().startsWith("Connect")) {
            // read the red pitaya device address from storage
            $( "#ipaddr" ).val(localStorage.getItem('mcpha_ipaddr'));
            $( "#port" ).val(localStorage.getItem('mcpha_port'));
            dialog_ipaddr.dialog( "open" );
          } else {
            ws.send("{\"type\":\"req\",\"command\":\"disconnect\"}");
          }
        });
        
        set_vertical_scale("ln");
        
        plot = $.plot("#spectrum-placeholder", [], options);

        var alreadyFetched = {};

        // Set Y display to linear
        $("button.yscale-ln-button").click(function () {
          set_vertical_scale("ln");
          replot(options);
        });

        // Set Y display to square root
        $("button.yscale-sq-button").click(function () {
          set_vertical_scale("sq");
          replot(options);
        });

        // Set Y display to log10
        $("button.yscale-lg-button").click(function () {
          set_vertical_scale("lg");
          replot(options);
        });

        // zoom to full channel extent button click handler
        $("button.zoom-full-extent-button").click(function () {
          $("button.zoom-in-button").removeClass("current-zoom");
          zoom_in = "";
          var axis = plot.getAxes();
          options.xaxis.min = axis.xaxis.datamin;
          options.xaxis.max = Math.ceil(axis.xaxis.datamax);
          options.yaxis.min = 0;
          options.yaxis.max = Math.ceil(axis.yaxis.datamax);
          options.xaxis.tickSize = get_zoom_ticks(
                  options.xaxis.min, options.xaxis.max);
          replot(options);
        });

        $("button.zoom-in-button").click(function () {
          if (zoom_mode === "") {
            set_selection_mode("zoomin");
          } else {
            zoom_mode = "";
            $("button.zoom-in-button").removeClass("current-zoom");
          }
          plot.clearSelection();
        });

        $("button.zoom-out-button").click(function () {
          set_selection_mode("clearall");
          if (plot.getData().length > 0) {
            // zoom out by a factor of 2
            var axes = plot.getAxes();
            var dmin = parseInt(axes.xaxis.datamin);
            var dmax = parseInt(axes.xaxis.datamax);
            var xmin = parseInt(options.xaxis.min);
            var xmax = parseInt(options.xaxis.max);
            var xrng = xmax - xmin;
            if (xrng*2 > (dmax-dmin)) {
              xmin = dmin;
              xmax = dmax;
            } else {
              xmin -= xrng;
              xmax += xrng;
              if (xmin < dmin) {
                xmin = dmin;
                xmax = xmin + (xrng * 2);
              } else if (xmax > dmax) {
                xmax = dmax;
                xmin = xmax - (xrng * 2);
              }
            }
            options.xaxis.min = xmin;
            options.xaxis.max = xmax;
            options.xaxis.tickSize = get_zoom_ticks(xmin, xmax);
            replot(options);
          }
        });

        $("button.pan-button").click(function () {
//          plot.pan({ left: -2 });
          options.xaxis.min = 5400;
          options.xaxis.max = 5500;
          replot(options);
        });

        //
        // Set initial acquisition time
        //
        if (localStorage.getItem("mcpha_acqtime") === null) {
          // use default value of 60 seconds
          localStorage.setItem('mcpha_acqtime', "60");
        }
        $( "#acqtime_s" ).text(localStorage.getItem("mcpha_acqtime"));
        
        //
        // Set acquisition time button click handler
        //
        $("#setacqtime").click(function () {
          $( "#acqtime" ).val(localStorage.getItem('mcpha_acqtime'));
          dialog_acqtime.dialog( "open" );
        });
        
        // set initial elapsedtime
        $( "#elapsedtime" ).text("0");

        //
        // START/STOP button click handler
        //
        $("#start").click(function () {
          if ( $("#start" ).text() === "Start") {
            ws.send("{\"type\":\"req\",\"command\":\"set_acquisition_state\",\"state\":1,\"acqtime\":"+
                    localStorage.getItem("mcpha_acqtime")+"}");
          } else {
            ws.send("{\"type\":\"req\",\"command\":\"set_acquisition_state\",\"state\":0}");
          }
        });

        //
        // CLEAR spectrum data button click handler
        //
        $("#clear_s_data").click(function () {
          ws.send("{\"type\":\"req\",\"command\":\"clear_spectrum_data\"}");
        });

        //
        // CLEAR aquisition timer button click handler
        //
        $("#clear_time").click(function () {
          $.notify("****CLEAR AQUISITION TIMER****", "info");
        });

        //
        // Set initial ROI total counts values
        //
        $( "#roi1_counts" ).text(0);
        $( "#roi2_counts" ).text(0);
        $( "#roi3_counts" ).text(0);

        //
        // Install set ROI #1 click handler
        //
        $("#roi1").click(function () {
          set_selection_mode("roi2set", 1);
        });

        //
        // Install set ROI #2 click handler
        //
        $("#roi2").click(function () {
          set_selection_mode("roi2set", 2);
        });

        //
        // Install set ROI #3 click handler
        //
        $("#roi3").click(function () {
          set_selection_mode("roi2set", 3);
        });

        //
        // PLOT SELECTION HANDLER
        //
        $("#spectrum-placeholder").bind("plotselected", function (event, ranges) {
          if (roi2set !== "") {
            ws.send("{\"type\":\"req\",\"command\":\"set_roi\",\"roi\":"+
                    roi2set+",\"from\":"+ranges.xaxis.from.toFixed(0)+",\"to\":"+
                    ranges.xaxis.to.toFixed(0)+"}");
            $("#roi"+roi2set).removeClass("current-roi");
            plot.clearSelection();
          }
        });

        //
        // Setup Zoomin click handler
        //
        $("#spectrum-placeholder").bind("plotclick", function (event, pos, item) {
          if (plot.getData().length > 0) {
            if (zoom_mode === "zoomin") {
              zoom_around_cursor_xpos(pos.x.toFixed(0));
            }
          }
        });

        $("#spectrum-placeholder").bind("plothover", function (event, pos, item) {
          if (plot.getData().length > 0) {
            if (zoom_mode === "zoomin") {
              $("#spectrum-placeholder").css("cursor","url(css/images/zoom-in.ico) 9 9, auto", "important");
            } else {
              $("#spectrum-placeholder").css("cursor","crosshair", "important");
            }
            var x = pos.x.toFixed(0);
            if (x > 0 && x < plot.getData()[0].data.length) {
              var y = plot.getData()[0].data[x][1];
              $("#cursor").text(x);
              $("#counts").text(y);
            }
          } else {
            $("#spectrum-placeholder").css("cursor","pointer","important");
          }
        });
        
        $("#cursor").text("0");

        // Catch keypressess
        // left = 37, up = 38, right = 39, down = 40
        $(document).keyup(function (e) {
          if (e.which === 37) {
            $.notify("****YOU PRESSED LEFT****", "info");
          } else if (e.which === 38) {
            adjust_vertical_scale_and_plot(options, +1);
          } else if (e.which === 39) {
            $.notify("****YOU PRESSED RIGHT****", "info");
          } else if (e.which === 40) {
            adjust_vertical_scale_and_plot(options, -1);
          } else if (e.which === 13) {
            $.notify("****YOU PRESSED ENTER****", "info");
          }
        });
        
        setAcquisitionButtonsEnabled(false);


        ///////////////////////////////////////////////////////////////////////////////////////////////////
        // SETUP SIDEBAR DIMENSIONS
        ///////////////////////////////////////////////////////////////////////////////////////////////////
        $('#sidebar-menu').toggle(function() {
          var w = $(window).width();
          $('.fragment-side-panel').animate({width:0+"px"});
          $('.fragment-body').animate({left:10, width:(w-25)+"px"});
        }, function(){
          var w = $(window).width();
          $('.fragment-side-panel').animate({width:300+"px"});
          $('.fragment-body').animate({left:311+"px", width:(w-327)+"px"});
        });
        $('#sidebar-menu').click();

        ///////////////////////////////////////////////////////////////////////////////////////////////////
        // SETUP OSCILLOSCOPE PLOT
        ///////////////////////////////////////////////////////////////////////////////////////////////////
        
        function plot_oscilloscope_data(label1, data1, label2, data2, params) {
          var data = [];
          
          if (label1) {
            data.push({label:label1, data:data1});
          }
          
          if (label2) {
            data.push({label:label2, data:data2});
          }
          
          oplot = $.plot("#oscilloscope-placeholder", data, params);
        }
    
        plot_oscilloscope_data(olabel0, odata0, olabel1, odata1, {});
    
        // Initialise data from local storage
        var p = localStorage.getItem('mcpha_osc_channels');
        if (p !== null && p !== 'undefined') {
          var ch = parseInt(p);
          $("#osc_channel_1").prop('checked', ch & 0x1);
          $("#osc_channel_2").prop('checked', ch & 0x2);
        } else {
          var channels = ($("#osc_channel_1").prop('checked') ? 1 : 0) +
                         ($("#osc_channel_2").prop('checked') ? 2 : 0);
          localStorage.setItem('mcpha_osc_channels', channels);
        }
        $('#osc_channel_1').on('click', function(e) {
          var channels = ($("#osc_channel_1").prop('checked') ? 1 : 0) +
                         ($("#osc_channel_2").prop('checked') ? 2 : 0);
          localStorage.setItem('mcpha_osc_channels', channels);
        });
        $('#osc_channel_2').on('click', function(e) {
          var channels = ($("#osc_channel_1").prop('checked') ? 1 : 0) +
                         ($("#osc_channel_2").prop('checked') ? 2 : 0);
          localStorage.setItem('mcpha_osc_channels', channels);
        });

        p = localStorage.getItem('mcpha_osc_dec_factor');
        if (p !== null && p !== 'undefined') {
          $("#osc_dec_factor").val(p);
        } else {
          // TODO: ensure number is between 4 and 8192 in increments of 4
          localStorage.setItem('mcpha_osc_dec_factor', $("#osc_dec_factor").text());
        }
        $('#osc_dec_factor').on('input', function(e) {
          // TODO: ensure number is between 4 and 8192 in increments of 4
          localStorage.setItem('mcpha_osc_dec_factor', $("#osc_dec_factor").val());
        });

        p = localStorage.getItem('mcpha_osc_trigger_mode');
        if (p !== null && p !== 'undefined') {
          $("#osc_trigger_mode").val(p);
        } else {
          localStorage.setItem('mcpha_osc_trigger_mode', $("#osc_trigger_mode").val());
        }
        $('#osc_trigger_mode').on('change', function(e) {
          localStorage.setItem('mcpha_osc_trigger_mode', $("#osc_trigger_mode").val());
        });

        p = localStorage.getItem('mcpha_osc_trigger_source');
        if (p !== null && p !== 'undefined') {
          $("#osc_trigger_source").val(p);
        } else {
          localStorage.setItem('mcpha_osc_trigger_source', $("#osc_trigger_source").val());
        }
        $('#osc_trigger_source').on('change', function(e) {
          localStorage.setItem('mcpha_osc_trigger_source', $("#osc_trigger_source").val());
        });

        p = localStorage.getItem('mcpha_osc_trigger_slope');
        if (p !== null && p !== 'undefined') {
          $("#osc_trigger_slope").val(p);
        } else {
          localStorage.setItem('mcpha_osc_trigger_slope', $("#osc_trigger_slope").val());
        }
        $('#osc_trigger_slope').on('change', function(e) {
          localStorage.setItem('mcpha_osc_trigger_slope', $("#osc_trigger_slope").val());
        });

        var p = localStorage.getItem('mcpha_osc_trigger_level');
        if (p !== null && p !== 'undefined') {
          $("#osc_trigger_level").val(p);
        } else {
          // TODO: ensure number is between -16380 and 16380 in increments of 5
          localStorage.setItem('mcpha_osc_trigger_level', $("#osc_trigger_level").val());
        }
        $('#osc_trigger_level').on('input', function(e) {
          // TODO: ensure number is between -16380 and 16380 in increments of 5
          localStorage.setItem('mcpha_osc_trigger_level', $("#osc_trigger_level").val());
        });
        
        //
        // Acquire oscilloscope data click handler
        //
        $("#acq_oscilloscope").click(function () {
          ws.send("{\"type\":\"req\",\"command\":\"acq_oscilloscope\""+
                  ",\"dec_factor\":"+$("#osc_dec_factor").val()+
                  ",\"trigger_mode\":\""+$("#osc_trigger_mode").val()+
                  "\",\"trigger_source\":"+$("#osc_trigger_source").val()+
                  ",\"trigger_slope\":\""+$("#osc_trigger_slope").val()+
                  "\",\"trigger_level\":"+$("#osc_trigger_level").val()+
                  ",\"channels\":"+localStorage.getItem('mcpha_osc_channels')+"}");
        });
        
        ///////////////////////////////////////////////////////////////////////////////////////////////////
        // INITIALISE TABS
        ///////////////////////////////////////////////////////////////////////////////////////////////////
        $( "#tabs" ).tabs({ active: 0 });
        $( "#tabs ul li").css({'margin-right':'25px','margin-left':'25px'});

        window.addEventListener('resize', resize_handler);
        
        // resize flot div
        resize_flot_div($(window).width(), $(window).height());
        
        $('#busy').prop('display', 'inline');
      });

    </script>
  </head>
  <body>
    <div class="busy" id="busy"></div>
    <div id="content">
      
      <div class="connection-panel-container">
        <div class="connection-panel-content">
          <div class="sidebar-menu" id="sidebar-menu" title="Toggle sidebar"></div>
          <div class="wsconnection" id="wsconnection" title="Websocket connection status"></div>
          <div class="rpconnection" id="rpconnection" title="Red Pitaya device connection status"></div>
          <button class="deviceip" id="deviceip" title="Set Red Pitaya device IP">Connect to Device</button>
        </div>
        <div class="logo">
          MCPHA Client
        </div>
      </div>

      <div id="tabs">
        <div id="fragment-mca">
            <div class="fragment-side-panel">
              <div class="side-panel-contents">
              <div class="prompt">Decimation factor</div>
              <input type="number" step="4" id="pha_dec_factor" value="4" class="text ui-widget-content ui-corner-all">
                <div class="prompt">Baseline substraction mode</div>
                <select id="baseline_subtraction_mode" class="text ui-widget-content ui-corner-all">
                  <option value="manual">Manual</option>
                  <option value="automatic">Automatic</option>
                </select>
                <div class="prompt">Baseline level</div>
                <input type="number" id="baseline_level" value="0" class="text ui-widget-content ui-corner-all">
                <div class="prompt" title="Lower level discriminator channel">LLD channel</div>
                <input type="text" id="lld" value="300" class="text ui-widget-content ui-corner-all">
                <div class="prompt" title="Upper level discriminator channel">ULD channel</div>
                <input type="text" id="uld" value="16300" class="text ui-widget-content ui-corner-all">
              </div>
            </div>
            <div class="fragment-body">
              <div class="cursor-panel-container">
                <div class="cursor-panel-content">Cursor ......... : <span class="onscreen-message" id="cursor"></span>
Counts ......... : <span class="onscreen-message" id="counts"></span>
Acq. Time (s) .. : <span class="onscreen-message" id="acqtime_s"></span>
Elapsed Time (s) : <span class="onscreen-message" id="elapsedtime"></span>
ROI #1 ......... : <span class="onscreen-message" id="roi1_counts"></span>
ROI #2 ......... : <span class="onscreen-message" id="roi2_counts"></span>
ROI #3 ......... : <span class="onscreen-message" id="roi3_counts"></span></div>
              </div>
              <div id="header">
                <button class="zoom-full-extent-button" title="Zoom channel view to full extent"></button>
                <button class="zoom-in-button" title="Zoom channel view in"></button>
                <button class="zoom-out-button" title="Zoom out channel view"></button>
                <button class="pan-button" title="Pan channel view"></button>
                <div style="width:8px;display:inline-block"></div>
                <button class="yscale-ln-button" title="Linear vertical scale">LN</button>
                <button class="yscale-sq-button" title="Square Root vertical scale">SQ</button>
                <button class="yscale-lg-button" title="Log 10 vertical scale">LG</button>
              </div>
              <div class="controls-panel-container">
                <div class="controls-panel-content">
                  <button class="button setacqtime" id="setacqtime" title="Set acquisition time">Acq. Time</button>
                  <button class="button start" id="start" title="Start spectrum acquisition">Start</button>
                  <button class="button clear_s_data" id="clear_s_data" title="Clear spectrum data">Clear Spc.</button>
                  <button class="button clear_time" id="clear_time" title="Clear aquisition time data">Clear Time</button>
                  <div style="width:8px;display:inline-block"></div>
                  <button class="button roi1" id="roi1" title="Set ROI #1">ROI #1</button>
                  <button class="button roi2" id="roi2" title="Set ROI #2">ROI #2</button>
                  <button class="button roi3" id="roi3" title="Set ROI #3">ROI #3</button>
                </div>
              </div>
              <div id="spectrum-placeholder" class="spectrum-placeholder"></div>
            </div>
        </div>

        <div id="dialog-ipaddr" title="Red Pitaya Device IP Address/Port">
          <p class="dialogPrompt">Enter device IP address and port.</p>

          <form>
            <fieldset>
              <label for="ipaddr">IP Address</label>
              <input type="text" name="ipaddr" id="ipaddr" value="0.0.0.0" class="text ui-widget-content ui-corner-all">

              <label for="port">Port</label>
              <input type="text" name="port" id="port" value="0" class="text ui-widget-content ui-corner-all">

              <!-- Allow form submission with keyboard without duplicating the dialog button -->
              <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
          </form>
        </div>

        <div id="dialog-acqtime" title="Aquisition Time">
          <p class="dialogPrompt">Enter acquisition time in seconds.</p>

          <form>
            <fieldset>
              <label for="acqtime">Acquisition Time (s)</label>
              <input type="text" name="acqtime" id="acqtime" value="60" class="text ui-widget-content ui-corner-all">

              <!-- Allow form submission with keyboard without duplicating the dialog button -->
              <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
          </form>
        </div>
        <div id="fragment-oscilloscope">
          <div class="fragment-side-panel">
            <div class="side-panel-contents">
              <div class="prompt">Channel 1
                <input type="checkbox" id="osc_channel_1" checked class="checkbox ui-widget-content ui-corner-all">
              </div>
              <div class="prompt">Channel 2
                <input type="checkbox" id="osc_channel_2" checked class="checkbox ui-widget-content ui-corner-all">
              </div>
              <div class="prompt">Decimation factor</div>
              <input type="number" step="4" id="osc_dec_factor" value="4" class="text ui-widget-content ui-corner-all">
              <div class="prompt">Trigger mode</div>
              <select id="osc_trigger_mode" class="text ui-widget-content ui-corner-all">
                <option selected="selected" value="n">Normal</option>
                <option value="a">Auto</option>
              </select>
              <div class="prompt">Trigger source</div>
              <select id="osc_trigger_source" class="text ui-widget-content ui-corner-all">
                <option selected="selected" value="1">Channel 1</option>
                <option value="2">Channel 2</option>
              </select>
              <div class="prompt">Trigger slope</div>
              <select id="osc_trigger_slope" class="text ui-widget-content ui-corner-all">
                <option selected="selected" value="r">Rising  _/¯  </option>
                <option value="f">Falling  ¯\_  </option>
              </select>
              <div class="prompt">Trigger Level</div>
              <input type="number" id="osc_trigger_level" step="5" value="200" class="text ui-widget-content ui-corner-all">
            </div>
          </div>
          <div class="fragment-body">
            <div class="controls-panel-container">
              <div class="controls-panel-content">
                <button class="button acq_oscilloscope" id="acq_oscilloscope" title="Start oscilloscope acquisition">Acquire Oscilloscope Data</button>
              </div>
            </div>
            <div id="oscilloscope-placeholder" class="spectrum-placeholder"></div>
          </div>
        </div>
        <div id="fragment-log">
          <div id="message-log"></div>
        </div>
        <div class="tabs-bar">
        <ul>
          <li><a href="#fragment-mca"><span>MCA</span></a></li>
          <li><a href="#fragment-oscilloscope"><span>Oscilloscope</span></a></li>
          <li><a href="#fragment-log"><span>Message Log</span></a></li>
        </ul>
        </div>
      </div>
    </div>
  
  </body>
</html>